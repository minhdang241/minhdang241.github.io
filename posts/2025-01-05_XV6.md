---
aliases:
- /OS/WriteUps/XV6-Lab3-2024
categories:
- Write-ups
date: '2024-06-04'
description: Answer for lab3 2024
image: images/xv6_mit.png
layout: post
title: "XV6 Series: MIT lab3 2024"
toc: true
draft: false

---
## Inspect a user-process page table
### General knowledge:
> xv6 is running on Sv39 RISC-V therefore only the bottom **39 bits** of 64-bit virtual address are used; the top 25 bits are not used. Within 39 bits, there are **27 bits** are used for Page Table Entry (PTE) index; the other **12 bits** are used for the offset.

> Each PTE contains a 44-bit physical page number (PPN) and 10-bit flags.

Given the PTE value, we can calculate the Physical Page Number (PPN) by the following:
```c
#define PTE2PA(pte) (((pte) >> 10) << 12)
```
- Right shift 10 bits to remove the flags
- Left shift 12 bits to align with the physical address where the bottom 12 bits are used for offset.

Given the PTE value, we can get the PTE Flags by the following:
```c
#define PTE_FLAGS(pte) ((pte) & 0x3FF)
```
- By using bit-wise AND with 0x3FF (001111111111), we can zero all the bits in the PTE except for the first 10 bits, representing the FLAGS.

A typical PTE in RISC-V has the following format:

| Bit Position | Name  | Description                                |
|--------------|-------|--------------------------------------------|
| 0            | V     | Indicates if the PTE is valid.             |
| 1            | R     | Page is readable.                          |
| 2            | W     | Page is writable.                          |
| 3            | X     | Page is executable.                        |
| 4            | U     | Accessible in user mode.                   |
| 5            | G     | Shared across all address spaces.          |
| 6            | A     | Set by hardware on the first access.       |
| 7            | D     | Set by hardware on the first write.        |
| 8-9          |       | Reserved for future use.                   |
| 10-53        | PPN   | Physical page number (mapping to memory).  |
| 54-63        |       | Reserved for future use.                   |

### Solution:
Approach:

1. Using the PTE format to decode the permission.
2. Using the order of virtual address to determine the page content since they are allocated in order.

| PTE entry                                          | Content      | Permission        |
| -------------------------------------------------- |--------------|-------------------|
|va 0x0 pte 0x21FCD85B pa 0x87F36000 perm 0x5B       | text         | 01011011 = AUXRV  |
|va 0x1000 pte 0x21FD1417 pa 0x87F45000 perm 0x17    | data segment | 00010111 = UWRV   |
|va 0x2000 pte 0x21FD1007 pa 0x87F44000 perm 0x7     | guard page   | 0111     = WRV    |    
|va 0x3000 pte 0x21FD40D7 pa 0x87F50000 perm 0xD7    | stack        | 11010111 = DAUWRV |             
|va 0x4000 pte 0x0 pa 0x0 perm 0x0                   | unused       |                   |              
|va 0x5000 pte 0x0 pa 0x0 perm 0x0                   | unused       |                   |
|va 0x6000 pte 0x0 pa 0x0 perm 0x0                   | unused       |                   |              
|va 0x7000 pte 0x0 pa 0x0 perm 0x0                   | unused       |                   |              
|va 0x8000 pte 0x0 pa 0x0 perm 0x0                   | unused       |                   |              
|va 0x9000 pte 0x0 pa 0x0 perm 0x0                   | unused       |                   |              
|va 0xFFFF6000 pte 0x0 pa 0x0 perm 0x0               | unused       |                   |              
|va 0xFFFF7000 pte 0x0 pa 0x0 perm 0x0               | unused       |                   |              
|va 0xFFFF8000 pte 0x0 pa 0x0 perm 0x0               | unused       |                   |              
|va 0xFFFF9000 pte 0x0 pa 0x0 perm 0x0               | unused       |                   |              
|va 0xFFFFA000 pte 0x0 pa 0x0 perm 0x0               | unused       |                   |              
|va 0xFFFFB000 pte 0x0 pa 0x0 perm 0x0               | unused       |                   |              
|va 0xFFFFC000 pte 0x0 pa 0x0 perm 0x0               | unused       |                   |              
|va 0xFFFFD000 pte 0x0 pa 0x0 perm 0x0               | unused       |                   |              
|va 0xFFFFE000 pte 0x21FC90C7 pa 0x87F24000 perm 0xC7| trapframe    | 11000111 = DAWRV  |            
|va 0xFFFFF000 pte 0x2000184B pa 0x80006000 perm 0x4B| trampoline   | 01001011 = AXRV   | 

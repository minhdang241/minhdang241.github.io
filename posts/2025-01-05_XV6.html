<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-01-05">
<meta name="description" content="Write-ups for Lab: Page tables">

<title>XV6 Series: MIT Labs 2024 – Minh Dang</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-879e302ca45bb6811b6062ec9bd6e23b.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-cf8269d776630912cf9a938f54d80202.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Minh Dang</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../list_100.html"> 
<span class="menu-text">List 100</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/minhdang241"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/minh-dang-60406b17b/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#inspect-a-user-process-page-table" id="toc-inspect-a-user-process-page-table" class="nav-link active" data-scroll-target="#inspect-a-user-process-page-table">Inspect a user-process page table</a>
  <ul class="collapse">
  <li><a href="#general-knowledge" id="toc-general-knowledge" class="nav-link" data-scroll-target="#general-knowledge">General knowledge:</a></li>
  <li><a href="#solution" id="toc-solution" class="nav-link" data-scroll-target="#solution">Solution:</a></li>
  </ul></li>
  <li><a href="#speed-up-system-calls" id="toc-speed-up-system-calls" class="nav-link" data-scroll-target="#speed-up-system-calls">Speed up system calls</a>
  <ul class="collapse">
  <li><a href="#general-knowledge-1" id="toc-general-knowledge-1" class="nav-link" data-scroll-target="#general-knowledge-1">General knowledge:</a></li>
  <li><a href="#solution-1" id="toc-solution-1" class="nav-link" data-scroll-target="#solution-1">Solution:</a></li>
  </ul></li>
  <li><a href="#print-a-page-table" id="toc-print-a-page-table" class="nav-link" data-scroll-target="#print-a-page-table">Print a page table</a>
  <ul class="collapse">
  <li><a href="#general-knowledge-2" id="toc-general-knowledge-2" class="nav-link" data-scroll-target="#general-knowledge-2">General knowledge:</a></li>
  <li><a href="#solution-2" id="toc-solution-2" class="nav-link" data-scroll-target="#solution-2">Solution:</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">XV6 Series: MIT Labs 2024</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Write-ups</div>
  </div>
  </div>

<div>
  <div class="description">
    Write-ups for Lab: Page tables
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 5, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="inspect-a-user-process-page-table" class="level2">
<h2 class="anchored" data-anchor-id="inspect-a-user-process-page-table">Inspect a user-process page table</h2>
<section id="general-knowledge" class="level3">
<h3 class="anchored" data-anchor-id="general-knowledge">General knowledge:</h3>
<blockquote class="blockquote">
<p>Since xv6 is running on Sv39 RISC-V, only the bottom <strong>39 bits</strong> of 64-bit virtual address are used; the top 25 bits are not used. Within 39 bits, there are <strong>27 bits</strong> are used for Page Table Entry (PTE) index; the other <strong>12 bits</strong> are used for the offset.</p>
</blockquote>
<blockquote class="blockquote">
<p>Each PTE contains a 44-bit physical page number (PPN) and 10-bit flags.</p>
</blockquote>
<p>Given the PTE value, we can calculate the Physical Page Number (PPN) by the following:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define PTE2PA</span><span class="op">(</span><span class="pp">pte</span><span class="op">)</span><span class="pp"> </span><span class="op">(((</span><span class="pp">pte</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> </span><span class="dv">10</span><span class="op">)</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span><span class="dv">12</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Right shift 10 bits to remove the flags</li>
<li>Left shift 12 bits to align with the physical address where the bottom 12 bits are used for offset.</li>
</ul>
<p>Given the PTE value, we can get the PTE Flags by the following:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define PTE_FLAGS</span><span class="op">(</span><span class="pp">pte</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">pte</span><span class="op">)</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0x3FF</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>By using bit-wise AND with 0x3FF (001111111111), we can zero all the bits in the PTE except for the first 10 bits, representing the FLAGS.</li>
</ul>
<p>A typical PTE in RISC-V has the following format:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Bit Position</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>V</td>
<td>Indicates if the PTE is valid.</td>
</tr>
<tr class="even">
<td>1</td>
<td>R</td>
<td>Page is readable.</td>
</tr>
<tr class="odd">
<td>2</td>
<td>W</td>
<td>Page is writable.</td>
</tr>
<tr class="even">
<td>3</td>
<td>X</td>
<td>Page is executable.</td>
</tr>
<tr class="odd">
<td>4</td>
<td>U</td>
<td>Accessible in user mode.</td>
</tr>
<tr class="even">
<td>5</td>
<td>G</td>
<td>Shared across all address spaces.</td>
</tr>
<tr class="odd">
<td>6</td>
<td>A</td>
<td>Set by hardware on the first access.</td>
</tr>
<tr class="even">
<td>7</td>
<td>D</td>
<td>Set by hardware on the first write.</td>
</tr>
<tr class="odd">
<td>8-9</td>
<td></td>
<td>Reserved for future use.</td>
</tr>
<tr class="even">
<td>10-53</td>
<td>PPN</td>
<td>Physical page number (mapping to memory).</td>
</tr>
<tr class="odd">
<td>54-63</td>
<td></td>
<td>Reserved for future use.</td>
</tr>
</tbody>
</table>
</section>
<section id="solution" class="level3">
<h3 class="anchored" data-anchor-id="solution">Solution:</h3>
<p>Approach:</p>
<ol type="1">
<li>Using the PTE format to decode the permission.</li>
<li>Using the order of virtual address to determine the page content since they are allocated in order.</li>
</ol>
<table class="caption-top table">
<colgroup>
<col style="width: 60%">
<col style="width: 16%">
<col style="width: 22%">
</colgroup>
<thead>
<tr class="header">
<th>PTE entry</th>
<th>Content</th>
<th>Permission</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>va 0x0 pte 0x21FCD85B pa 0x87F36000 perm 0x5B</td>
<td>text</td>
<td>01011011 = AUXRV</td>
</tr>
<tr class="even">
<td>va 0x1000 pte 0x21FD1417 pa 0x87F45000 perm 0x17</td>
<td>data segment</td>
<td>00010111 = UWRV</td>
</tr>
<tr class="odd">
<td>va 0x2000 pte 0x21FD1007 pa 0x87F44000 perm 0x7</td>
<td>guard page</td>
<td>0111 = WRV</td>
</tr>
<tr class="even">
<td>va 0x3000 pte 0x21FD40D7 pa 0x87F50000 perm 0xD7</td>
<td>stack</td>
<td>11010111 = DAUWRV</td>
</tr>
<tr class="odd">
<td>va 0x4000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="even">
<td>va 0x5000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="odd">
<td>va 0x6000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="even">
<td>va 0x7000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="odd">
<td>va 0x8000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="even">
<td>va 0x9000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="odd">
<td>va 0xFFFF6000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="even">
<td>va 0xFFFF7000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="odd">
<td>va 0xFFFF8000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="even">
<td>va 0xFFFF9000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="odd">
<td>va 0xFFFFA000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="even">
<td>va 0xFFFFB000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="odd">
<td>va 0xFFFFC000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="even">
<td>va 0xFFFFD000 pte 0x0 pa 0x0 perm 0x0</td>
<td>unused</td>
<td></td>
</tr>
<tr class="odd">
<td>va 0xFFFFE000 pte 0x21FC90C7 pa 0x87F24000 perm 0xC7</td>
<td>trapframe</td>
<td>11000111 = DAWRV</td>
</tr>
<tr class="even">
<td>va 0xFFFFF000 pte 0x2000184B pa 0x80006000 perm 0x4B</td>
<td>trampoline</td>
<td>01001011 = AXRV</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="speed-up-system-calls" class="level2">
<h2 class="anchored" data-anchor-id="speed-up-system-calls">Speed up system calls</h2>
<section id="general-knowledge-1" class="level3">
<h3 class="anchored" data-anchor-id="general-knowledge-1">General knowledge:</h3>
<blockquote class="blockquote">
<p>System calls usually require a context switch from user mode to kernel mode, which is expensive. To speed up the certain system calls, we use a technique called <strong>virtual dynamic shared object</strong> (vDSO). vDSO is a kernel mechanism for exporting a carefully <strong>selected set of kernel space routines</strong> to user space applications so that applications can call these kernel space routines in-process, without incurring the performance penalty of a mode switch from user mode to kernel mode that is inherent when calling these same kernel space routines by means of the system call interface.</p>
</blockquote>
<p>Besides, we should also understand how xv6 <strong>allocates pages</strong> to the process and how the <strong>virtual memory mapping to the physical memory.</strong></p>
<p><strong>TBU:</strong> explain those concepts.</p>
</section>
<section id="solution-1" class="level3">
<h3 class="anchored" data-anchor-id="solution-1">Solution:</h3>
<ul>
<li><code>ugetpid()</code> is declared in the file <code>user/user.h</code>, thus any user program can call it.</li>
<li>Also, the definition of <code>ugetpid()</code> is defined in the <code>user/ulib.c</code> file as follows:</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ugetpid<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> usyscall <span class="op">*</span>u <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> usyscall <span class="op">*)</span>USYSCALL<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> u<span class="op">-&gt;</span>pid<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>From the definition, we can see that the <code>pid</code> is stored in the <code>usyscall</code> structure, which is defined in <code>kernel/memlayout.h</code> as follows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> usyscall <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> pid<span class="op">;</span>  <span class="co">// Process ID</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The problem description suggests that: &gt; When each process is created, map one read-only page at USYSCALL. At the start of this page, store a struct usyscall</p>
<p>The <code>USYSCALL</code> is defined in the <code>kernel/memlayout.h</code> as follows:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define USYSCALL </span><span class="op">(</span><span class="pp">TRAPFRAME </span><span class="op">-</span><span class="pp"> PGSIZE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That means the <code>struct usyscall</code> is stored in the page right after the <code>TRAPFRAME</code> page.</p>
<p>To do that, we have to deep into the function where the memory is allocated for the process. In this case, it is the <code>alloproc</code> function defined in <code>kernel/proc.c</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> proc<span class="op">*</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>allocproc<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>allocproc</code> uses the function <code>kalloc</code> to allocate 4096-byte page in physical memory to process’s component. For example, this is the line where a single page in physical memory is allocated for the process’s trapframe.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>p<span class="op">-&gt;</span>trapframe <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> trapframe <span class="op">*)</span>kalloc<span class="op">()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After this line, the <code>p-&gt;trapframe</code> contains the memory of the page a.k.a. It plays as a pointer to the page in physical memory.</p>
<p>Thus, to allocate a page for the <code>struct usyscall</code>, we can use the following code:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">((</span>p<span class="op">-&gt;</span>usyscall <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> usyscall <span class="op">*)</span>kalloc<span class="op">())</span> <span class="op">==</span> <span class="dv">0</span><span class="op">){</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  freeproc<span class="op">(</span>p<span class="op">)</span> <span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  release<span class="op">(&amp;</span>p<span class="op">-&gt;</span>lock<span class="op">);</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We also assign the process ID to the <code>usyscall</code> structure as follows:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>p<span class="op">-&gt;</span>usyscall<span class="op">-&gt;</span>pid <span class="op">=</span> p<span class="op">-&gt;</span>pid<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we map the physical address to virtual address of the process via the function <code>proc_pagetable</code> defined in the file <code>kernel/proc.c</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span><span class="op">(</span>mappages<span class="op">(</span>pagetable<span class="op">,</span> USYSCALL<span class="op">,</span> PGSIZE<span class="op">,</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>              <span class="op">(</span>uint64<span class="op">)(</span>p<span class="op">-&gt;</span>usyscall<span class="op">),</span> PTE_R <span class="op">|</span> PTE_U<span class="op">)</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>      uvmunmap<span class="op">(</span>pagetable<span class="op">,</span> TRAMPOLINE<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>      uvmunmap<span class="op">(</span>pagetable<span class="op">,</span> TRAPFRAME<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>      uvmfree<span class="op">(</span>pagetable<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The function <code>mappages</code> is used to create a pagetable entry for the given physical address.</p>
<p>After the mapping is successful, the system can use the pagetable to convert the virtual address into physical address. That it’s. The rest of the code is to clean up the memory when freeing the process, which is defined in the <code>freeproc</code> function.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>freeproc<span class="op">(</span><span class="kw">struct</span> proc <span class="op">*</span>p<span class="op">)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>p<span class="op">-&gt;</span>usyscall<span class="op">)</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    kfree<span class="op">((</span><span class="dt">void</span><span class="op">*)</span>p<span class="op">-&gt;</span>usyscall<span class="op">);</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="print-a-page-table" class="level2">
<h2 class="anchored" data-anchor-id="print-a-page-table">Print a page table</h2>
<section id="general-knowledge-2" class="level3">
<h3 class="anchored" data-anchor-id="general-knowledge-2">General knowledge:</h3>
<blockquote class="blockquote">
<p>Xv6 uses a three-level pagetable. For each level, there are 2^9 (512) entries. The first and second level entries contain the physical addresses for page-table pages in the lower level, while the lowest level entries contain the physical page number (PPN).</p>
</blockquote>
<blockquote class="blockquote">
<p>The pagetable entries are stored sequentially in the memory as follows:</p>
</blockquote>
<pre><code>| Level2_Entry0 | Level1_Entry0 | Level0_Entry0 | ... | Level2_Entry1 | Level1_Entry0 | Level0_Entry0 | ...    </code></pre>
<p>Thus, the gap between 2 PTE varies by level: - Level 2 entries: 512 * 512 * PGSIZE - Level 1 entries: 512 * PGSIZE - Level 0 entries: PGSIZE</p>
<blockquote class="blockquote">
<p>The virtual address of the first pagetable entry is 0, which is set in the <code>uvmfirst</code> function.</p>
</blockquote>
<div class="sourceCode" id="cb13"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>uvmfirst<span class="op">(</span>pagetable_t pagetable<span class="op">,</span> uchar <span class="op">*</span>src<span class="op">,</span> uint sz<span class="op">)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>mem<span class="op">;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>sz <span class="op">&gt;=</span> PGSIZE<span class="op">)</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    panic<span class="op">(</span><span class="st">"uvmfirst: more than a page"</span><span class="op">);</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  mem <span class="op">=</span> kalloc<span class="op">();</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  memset<span class="op">(</span>mem<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> PGSIZE<span class="op">);</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  mappages<span class="op">(</span>pagetable<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> PGSIZE<span class="op">,</span> <span class="op">(</span>uint64<span class="op">)</span>mem<span class="op">,</span> PTE_W<span class="op">|</span>PTE_R<span class="op">|</span>PTE_X<span class="op">|</span>PTE_U<span class="op">);</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  memmove<span class="op">(</span>mem<span class="op">,</span> src<span class="op">,</span> sz<span class="op">);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="solution-2" class="level3">
<h3 class="anchored" data-anchor-id="solution-2">Solution:</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>vmprint_helper<span class="op">(</span>pagetable_t pagetable<span class="op">,</span> uint64 level<span class="op">,</span> uint64 va<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  uint64 sz <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>level <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> sz <span class="op">=</span> <span class="dv">512</span> <span class="op">*</span> <span class="dv">512</span> <span class="op">*</span> PGSIZE<span class="op">;</span> </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>level <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> sz <span class="op">=</span> <span class="dv">512</span> <span class="op">*</span> PGSIZE<span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> sz <span class="op">=</span> PGSIZE<span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">512</span><span class="op">;</span> i<span class="op">++,</span> va <span class="op">+=</span> sz<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    pte_t pte <span class="op">=</span> <span class="op">*(</span>pagetable <span class="op">+</span> i<span class="op">);</span> <span class="co">// Dereference the pagetable pointer to get the pagetable entry content</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>pte <span class="op">&amp;</span> PTE_V<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">3</span> <span class="op">-</span> level<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> printf<span class="op">(</span><span class="st">" .."</span><span class="op">);</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"</span><span class="sc">%p</span><span class="st">: pte </span><span class="sc">%p</span><span class="st"> pa </span><span class="sc">%p\n</span><span class="st">"</span><span class="op">,</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*)</span> va<span class="op">,</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*)</span> pte<span class="op">,</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*)</span> PTE2PA<span class="op">(</span>pte<span class="op">));</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>PTE_LEAF<span class="op">(</span>pte<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="co">// if it is not the leave</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        vmprint_helper<span class="op">((</span><span class="dt">void</span> <span class="op">*)</span> PTE2PA<span class="op">(</span>pte<span class="op">),</span> level <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> va<span class="op">);</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/minhdang241\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="minhdang241/minhdang241.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>